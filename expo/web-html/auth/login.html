<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>cuzcatlansv.ride - Login</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/responsive.css">
    <link rel="stylesheet" href="login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Aumentar espacios entre l√≠neas */
        .login-title {
            margin-bottom: 2.5rem !important;
            line-height: 1.4;
        }
        
        .login-subtitle {
            margin-bottom: 3.5rem !important;
            line-height: 1.6;
        }
        
        .login-options {
            margin-bottom: 3.5rem !important;
        }
        

        
        .form-container {
            padding: 4rem !important;
        }
        
        /* Loading indicator styles */
        .loading-indicator {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-indicator p {
            color: rgba(255, 255, 255, 0.8);
            margin: 0;
            font-size: 0.9rem;
        }
        
        .error-message {
            text-align: center;
            color: #ff6b6b;
        }
        
        .error-message p {
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .loading-message {
            text-align: center;
        }
        
        .loading-message small {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
            display: block;
            margin-top: 0.5rem;
        }
        
        /* Cambiar el fondo para mejor visibilidad */
        .login-screen {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%) !important;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .form-container {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 3rem !important;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            max-width: 600px;
            width: 90%;
        }
        
        .login-title {
            color: #1f2937 !important;
            text-align: center;
        }
        
        .login-subtitle {
            color: #6b7280 !important;
            text-align: center;
        }
        
        /* Estilos para las opciones de Google */
        .google-option {
            margin-bottom: 2rem;
            text-align: center;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .google-option h3 {
            color: #1f2937 !important;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        
        /* Bot√≥n Glassmorphism Azul */
        .google-btn-glass {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9), rgba(37, 99, 235, 0.8), rgba(29, 78, 216, 0.7)) !important;
            backdrop-filter: blur(25px) !important;
            -webkit-backdrop-filter: blur(25px) !important;
            border: 2px solid rgba(255, 255, 255, 0.6) !important;
            color: white !important;
            padding: 16px 32px !important;
            border-radius: 20px !important;
            font-size: 1rem !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 14px !important;
            margin: 0 auto !important;
            min-width: 240px !important;
            box-shadow: 0 10px 40px rgba(59, 130, 246, 0.4), 0 0 20px rgba(59, 130, 246, 0.2) !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.4) !important;
            position: relative !important;
            overflow: hidden !important;
        }
        
        .google-btn-glass::before {
            content: '' !important;
            position: absolute !important;
            top: 0 !important;
            left: -100% !important;
            width: 100% !important;
            height: 100% !important;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent) !important;
            transition: left 0.6s ease !important;
        }
        
        .google-btn-glass:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.95), rgba(29, 78, 216, 0.9), rgba(30, 64, 175, 0.85)) !important;
            border-color: rgba(255, 255, 255, 0.8) !important;
            transform: translateY(-4px) scale(1.02) !important;
            box-shadow: 0 15px 50px rgba(59, 130, 246, 0.5), 0 0 30px rgba(59, 130, 246, 0.3) !important;
        }
        
        .google-btn-glass:hover:not(:disabled)::before {
            left: 100% !important;
        }
        
        .google-btn-glass i {
            font-size: 1.3rem !important;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3)) !important;
            z-index: 2 !important;
            position: relative !important;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="form-container">
            <h1 class="login-title">cuzcatlansv.ride</h1>
            <p class="login-subtitle">Inicia sesi√≥n para continuar</p>
            
            <div class="login-options">
                <div id="loadingIndicator" class="loading-indicator" style="display: none;">
                    <div class="spinner"></div>
                    <p>Cargando Firebase y servicios...</p>
                    <small>Esto puede tomar unos segundos en la primera carga</small>
                </div>
                
                <!-- Bot√≥n Glassmorphism Azul -->
                <div class="google-option">
                    <button id="googleSignInBtn" class="google-btn-glass" style="display: none;">
                        <i class="fab fa-google"></i>
                        Iniciar sesi√≥n con Google
                    </button>
                </div>
            </div>
            

        </div>
    </div>

    <!-- Scripts de la aplicaci√≥n -->
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    
    <script>
        // Inicializar la aplicaci√≥n cuando se carga
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('‚úÖ Login page cargado correctamente');
            
            // Mostrar la pantalla de login
            const loginScreen = document.getElementById('loginScreen');
            if (loginScreen) {
                loginScreen.style.display = 'flex';
                console.log('‚úÖ Pantalla de login mostrada');
            }
            
            // Mostrar indicador de carga
            const loadingIndicator = document.getElementById('loadingIndicator');
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            
            if (loadingIndicator) loadingIndicator.style.display = 'block';
            if (googleSignInBtn) googleSignInBtn.style.display = 'none';
            
                         // Inicializar el servicio de autenticaci√≥n
             if (window.authService) {
                 try {
                     console.log('üîß Iniciando inicializaci√≥n del servicio de autenticaci√≥n...');
                     
                                           // Agregar un timeout para evitar que se muestre error muy r√°pido
                      const initTimeout = setTimeout(() => {
                          if (loadingIndicator && loadingIndicator.querySelector('.spinner')) {
                              console.log('‚è∞ Firebase est√° tardando en cargar, mostrando mensaje de espera...');
                              loadingIndicator.innerHTML = `
                                  <div class="loading-message">
                                      <div class="spinner"></div>
                                      <p>Firebase est√° tardando en cargar...</p>
                                      <small>Esto puede tomar unos segundos</small>
                                  </div>
                              `;
                          }
                      }, 10000); // 10 segundos
                     
                     await window.authService.init();
                     
                     // Limpiar timeout si se complet√≥ exitosamente
                     clearTimeout(initTimeout);
                     
                     console.log('‚úÖ Servicio de autenticaci√≥n inicializado');
                    
                    // Ocultar indicador de carga y mostrar bot√≥n
                    if (loadingIndicator) loadingIndicator.style.display = 'none';
                    if (googleSignInBtn) googleSignInBtn.style.display = 'block';
                    
                    // Configurar el bot√≥n de Google Sign-In
                    if (googleSignInBtn) {
                        googleSignInBtn.addEventListener('click', async () => {
                            try {
                                console.log('üñ±Ô∏è Bot√≥n Google Sign-In clickeado');
                                googleSignInBtn.disabled = true;
                                googleSignInBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conectando...';
                                
                                await window.authService.signInWithGoogle();
                                console.log('‚úÖ Autenticaci√≥n con Google iniciada');
                            } catch (error) {
                                console.error('‚ùå Error en autenticaci√≥n con Google:', error);
                                googleSignInBtn.disabled = false;
                                googleSignInBtn.innerHTML = '<i class="fab fa-google"></i> Iniciar sesi√≥n con Google';
                                alert('Error al conectar con Google: ' + error.message);
                            }
                        });
                        console.log('‚úÖ Listener de Google Sign-In configurado');
                    }
                    
                                         // Verificar si ya hay un usuario autenticado ANTES de configurar el listener
                     const firebaseUser = window.authService.auth.currentUser;
                     const storedUser = localStorage.getItem(CONFIG.STORAGE_KEYS.USER_DATA);
                     
                     console.log('üîç Usuario Firebase:', firebaseUser ? 'S√ç' : 'NO');
                     console.log('üîç Usuario en localStorage:', storedUser ? 'S√ç' : 'NO');
                     console.log('üîç localStorage completo:', localStorage);
                     
                     // Verificar si se hizo logout recientemente
                     const logoutFlag = sessionStorage.getItem('logout_flag');
                     if (logoutFlag === 'true') {
                         console.log('üö™ Logout detectado, limpiando flag y no procesando autenticaci√≥n...');
                         sessionStorage.removeItem('logout_flag');
                         
                         // Forzar cierre de sesi√≥n de Firebase si a√∫n est√° activo
                         if (firebaseUser) {
                             console.log('üî• Forzando cierre de sesi√≥n de Firebase...');
                             await window.authService.auth.signOut();
                             
                             // Esperar m√°s tiempo para que Firebase procese el logout completamente
                             await new Promise(resolve => setTimeout(resolve, 1000));
                         }
                         
                         // Limpiar localStorage completamente despu√©s del logout
                         localStorage.clear();
                         
                         // Limpiar el flag despu√©s de un tiempo para permitir futuras autenticaciones
                         setTimeout(() => {
                             sessionStorage.removeItem('logout_flag');
                             console.log('üßπ Logout flag limpiado despu√©s del timeout');
                         }, 5000);
                         
                         return; // No procesar autenticaci√≥n despu√©s de logout
                     }
                     
                     // Si ya hay usuario autenticado Y no hay logout flag, redirigir inmediatamente
                     if (firebaseUser && firebaseUser.uid && !sessionStorage.getItem('logout_flag')) {
                         console.log('üîê Usuario ya autenticado, redirigiendo directamente...');
                         
                         if (loadingIndicator) {
                             loadingIndicator.innerHTML = `
                                 <div class="loading-message">
                                     <div class="spinner"></div>
                                     <p>Usuario ya autenticado</p>
                                     <small>Redirigiendo al panel...</small>
                                 </div>
                             `;
                         }
                         
                         setTimeout(() => {
                             window.location.href = '../home/home.html';
                         }, 2000);
                         return; // No continuar con el resto del c√≥digo
                     }
                     
                     // Si no hay usuario en Firebase pero hay en localStorage, verificar
                     if (!firebaseUser && storedUser) {
                         try {
                             const userData = JSON.parse(storedUser);
                             if (userData.uid && userData.role === 'admin') {
                                 console.log('üîê Usuario admin v√°lido en localStorage, redirigiendo...');
                                 
                                 if (loadingIndicator) {
                                     loadingIndicator.innerHTML = `
                                         <div class="loading-message">
                                             <div class="spinner"></div>
                                             <p>Usuario encontrado</p>
                                             <small>Redirigiendo al panel...</small>
                                         </div>
                                     `;
                                 }
                                 
                                 setTimeout(() => {
                                     window.location.href = '../home/home.html';
                                 }, 2000);
                                 return; // No continuar con el resto del c√≥digo
                             }
                         } catch (e) {
                             console.log('‚ö†Ô∏è Error parseando datos de usuario del localStorage');
                         }
                     }
                     
                     // Solo si NO hay usuario autenticado, configurar el listener
                     console.log('üîê No hay usuario autenticado, configurando listener...');
                     
                     // Escuchar cambios de autenticaci√≥n solo para usuarios nuevos
                     const unsubscribe = window.authService.onAuthStateChanged(async (isAuthenticated, user) => {
                         if (isAuthenticated && user) {
                             console.log('üîê Nuevo usuario autenticado, redirigiendo...');
                             
                             // Desuscribirse inmediatamente
                             if (typeof unsubscribe === 'function') {
                                 unsubscribe();
                             }
                             
                             // Redirigir
                             setTimeout(() => {
                                 window.location.href = '../home/home.html';
                             }, 1000);
                         }
                     });
                    
                } catch (error) {
                    console.error('‚ùå Error inicializando servicio de autenticaci√≥n:', error);
                    
                                         // Mostrar error y bot√≥n de reintento
                     if (loadingIndicator) {
                         loadingIndicator.innerHTML = `
                             <div class="error-message">
                                 <p>‚ùå Error cargando servicios</p>
                                 <p><small>${error.message}</small></p>
                                 <button id="retryBtn" class="btn btn-secondary">Reintentar</button>
                             </div>
                         `;
                         
                         // Agregar listener al bot√≥n de reintento
                         const retryBtn = document.getElementById('retryBtn');
                         if (retryBtn) {
                             retryBtn.addEventListener('click', () => {
                                 console.log('üîÑ Reintentando carga de servicios...');
                                 location.reload();
                             });
                         }
                     }
                }
            } else {
                console.error('‚ùå Servicio de autenticaci√≥n no disponible');
                
                                 // Mostrar error si el servicio no est√° disponible
                 if (loadingIndicator) {
                     loadingIndicator.innerHTML = `
                         <div class="error-message">
                             <p>‚ùå Servicio de autenticaci√≥n no disponible</p>
                             <button id="retryBtn2" class="btn btn-secondary">Reintentar</button>
                         </div>
                     `;
                     
                     // Agregar listener al bot√≥n de reintento
                     const retryBtn2 = document.getElementById('retryBtn2');
                     if (retryBtn2) {
                         retryBtn2.addEventListener('click', () => {
                             console.log('üîÑ Reintentando carga de servicios...');
                             location.reload();
                         });
                     }
                 }
            }
        });
    </script>
</body>
</html>
